# State Machine
<p align="center" >
  <a href="https://docs.google.com/drawings/d/1a7vZAM9WuwPWO6OKUwSEO41QpbavJ21Ey1W6o_kQHq8/edit?usp=sharing" target="_blank"><img src="https://raw.github.com/CANDY-HOUSE/SesameSDK_iOS_with_DemoApp/assets/CHSesame2StateMachine.png" alt="Sesame2 State Machine" title="Sesame2 State Machine"></a>
</p>

# CHSesame2Status
```Swift
case noBleSignal(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "noBleSignal") // SesameSDKがセサミデバイスのBluetooth Advertisementを未だ見つけていない
case receivedBle(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "receivedBle") // SesameSDKがセサミデバイスのBluetooth Advertisementを見つけました
case bleConnecting(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "bleConnecting") // SesameSDKがセサミデバイスとBluetooth接続しようとしている
case reset(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "reset") // セサミデバイスが Bluetoothコマンドやリセットボタンで リセットされた一瞬のステータスで、その後 noBleSignal に戻る。
case waitingGatt(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "waitingGatt") // SesameSDKがセサミデバイスとBluetooth接続しようとしている途中、Bluetooth GATTの応答を待っています
case bleLogining(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "bleLogining") // SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスも登録済で、セサミデバイスの鍵を挿入している途中
case readyToRegister(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "readyToRegister") // SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスが未登録状態で、registerSesame2()待ちです
case waitingForAuth(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "waitingForAuth")
case registering(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "registering") // SesameSDKがセサミデバイスとBluetooth接続出来て、registerSesame2()処理中です
case dfumode(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "dfumode")
case locked(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "locked") // 下記のケース１。SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスも登録済で、正しいセサミデバイスの鍵も挿入済。
case unlocked(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "unlocked") // 下記のケース2。SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスも登録済で、正しいセサミデバイスの鍵も挿入済。
case moved(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "moved") // 下記のケース3。SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスも登録済で、正しいセサミデバイスの鍵も挿入済。
case noSettings(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "noSettings") // SesameSDKがセサミデバイスとBluetooth接続出来て、セサミデバイスも登録済で、正しいセサミデバイスの鍵も挿入済で、セサミデバイスの施解錠の角度は未だ未設定です
case waitApConnect(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "waitApConnect")
case busy(loginStatus: CHDeviceLoginStatus = .unlogined, desc: String = "busy")
case iotConnected(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "iotConnected")
case iotDisconnected(loginStatus: CHDeviceLoginStatus = .logined, desc: String = "iotDisconnected")
```
```Swift
/*
補足１：現時点では状態は以下の３つのみとなっています。
  ＜ケース１：施錠＞
    サムターンが施錠の点にある場合、
    施錠　1
    解錠　0　
  ＜ケース２：解錠＞
    サムターンが解錠の点にある場合、
    施錠　0
    解錠　1
  ＜ケース３：それ以外（※現時点では「解錠」とUI上で表示しています。 ＞
    サムターンが以上の２点以外にある場合、
    施錠　0
    解錠　0


補足２：現時点のSesameSDKとAPPでは解錠と施錠は「点」となっておりますが、今後ユーザー様が解錠/施錠状態を範囲で設定出来る様に変更予定で、ファームウェアには既にその機能は実装しております。
*/
```

## if(!isRegistered) セサミデバイスが未登録の場合の状態遷移表
|現在状態 →<br>入力 ↓|noBleSignal|receivedBle|bleConnecting|waitingGatt|readyToRegister|registering|noSettings |
|:-------------:|:---------:|:-----------:|:-------------:|:---------:|:---------------:|:----------:|:----------:|
|セサミデバイスが近くにあれば|receivedBle|       |               |           |                 |            |            |
|  connect()    |           |bleConnecting|               |           |                 |            |            |
|bleConnecting<br><sub>SDKが自動的に進む</sub>|||waitingGatt |           |                 |            |            |
|waitingGatt<br><sub>SDKが自動的に進む</sub>|||              |readyToRegister|             |            |            |
|  registerSesame2()|       |             |               |           | registering     |            |            |
|registering<br><sub>SDKが自動的に進む</sub>|||              |           |                 | noSettings |            |
|  configureLockPosition()| |             |               |           |                 |            |locked/unlocked/moved<br>(isRegistered)|
|  disconnect() |           |             |               |           |                 |            | noBleSignal|

## if(isRegistered) セサミデバイスが登録済の場合の状態遷移表
|現在状態 →<br>入力 ↓|noBleSignal|receivedBle|bleConnecting|waitingGatt|bleLogining|locked/unlocked/moved|noSettings|
|:-------------:|:---------:|:-----------:|:-----------:|:--------:|:---------------:|:----------:|:----------:|
|セサミデバイスが近くにあれば|receivedBle |      |             |          |                 |            |            |
|  connect()    |           |bleConnecting|             |          |                 |            |            |
|bleConnecting<br><sub>SDKが自動的に進む</sub>|||waitingGatt|         |                 |            |            |
|waitingGatt<br><sub>SDKが自動的に進む</sub>|||            |bleLogining|                |            |            |
|bleLogining<br><sub>SDKが自動的に進む</sub>|||            |          |locked/unlocked/moved/<br>noSettings||     |           
|  lock()       |           |             |             |          |                 | unlocked   |            |
|  unlock()     |           |             |             |          |                 | locked     |            |
|  toggle()     |           |             |             |          |                 |locked/unlocked|         |
|  disconnect() |           |             |             |          | noBleSignal     |noBleSignal |noBleSignal |
